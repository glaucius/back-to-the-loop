{% extends "base.html" %}

{% block title %}{{ backyard.nome }} - Controle de Loops{% endblock %}

{% block content %}
<div class="content-wrapper">
  <!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-8">
          <h1 class="m-0">
            üèÉ‚Äç‚ôÇÔ∏è {{ backyard.nome }}
            {% if backyard.status.value == 'ATIVO' %}
              <span class="badge badge-success ml-2">üü¢ AO VIVO</span>
            {% elif backyard.status.value == 'PREPARACAO' %}
              <span class="badge badge-warning ml-2">üü° PREPARA√á√ÉO</span>
            {% elif backyard.status.value == 'FINALIZADO' %}
              <span class="badge badge-danger ml-2">üî¥ FINALIZADO</span>
            {% endif %}
          </h1>
          <p class="text-muted">
            <i class="fas fa-map-marker-alt"></i> {{ backyard.cidade }}, {{ backyard.estado }}
            {% if backyard.data_evento %}
              | <i class="fas fa-calendar"></i> {{ backyard.data_evento.strftime('%d/%m/%Y') }}
            {% endif %}
          </p>
        </div>
        <div class="col-sm-4">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('backyards.list_backyards') }}">Backyards</a></li>
            <li class="breadcrumb-item active">{{ backyard.nome }}</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      
      <!-- Estat√≠sticas Gerais -->
      <div class="row">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ total_atletas_inscritos }}</h3>
              <p>Atletas Inscritos</p>
            </div>
            <div class="icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ total_loops }}</h3>
              <p>Total de Loops</p>
            </div>
            <div class="icon">
              <i class="fas fa-sync"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ atletas_ativos }}</h3>
              <p>Atletas Ativos</p>
            </div>
            <div class="icon">
              <i class="fas fa-running"></i>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-6">
          <div class="small-box bg-danger">
            <div class="inner">
              <h3>{{ total_loops_finalizados }}</h3>
              <p>Loops Finalizados</p>
            </div>
            <div class="icon">
              <i class="fas fa-flag-checkered"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Loop Atual em Destaque -->
      {% if loop_atual %}
      <div class="row">
        <div class="col-12">
          <div class="card card-primary card-outline">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-trophy"></i> 
                <strong>Loop Atual: #{{ loop_atual.numero_loop }}</strong>
                {% if loop_atual.status.value == 'ATIVO' %}
                  <span class="badge badge-success ml-2">üî¥ EM ANDAMENTO</span>
                {% elif loop_atual.status.value == 'PREPARACAO' %}
                  <span class="badge badge-warning ml-2">üü° PREPARA√á√ÉO</span>
                {% elif loop_atual.status.value == 'FINALIZADO' %}
                  <span class="badge badge-secondary ml-2">‚úÖ FINALIZADO</span>
                {% endif %}
              </h3>
              <div class="card-tools">
                {% if loop_atual.data_inicio %}
                  <span class="text-muted">
                    <i class="fas fa-clock"></i> 
                    In√≠cio: {{ loop_atual.data_inicio.strftime('%H:%M:%S') }}
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="info-box bg-light">
                    <span class="info-box-icon bg-success"><i class="fas fa-play"></i></span>
                    <div class="info-box-content">
                      <span class="info-box-text">Ativos</span>
                      <span class="info-box-number">{{ atletas_ativos }}</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-box bg-light">
                    <span class="info-box-icon bg-primary"><i class="fas fa-check"></i></span>
                    <div class="info-box-content">
                      <span class="info-box-text">Conclu√≠dos</span>
                      <span class="info-box-number">{{ atletas_concluidos }}</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-box bg-light">
                    <span class="info-box-icon bg-danger"><i class="fas fa-times"></i></span>
                    <div class="info-box-content">
                      <span class="info-box-text">Eliminados</span>
                      <span class="info-box-number">{{ atletas_eliminados }}</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="info-box bg-light">
                    <span class="info-box-icon bg-info"><i class="fas fa-percentage"></i></span>
                    <div class="info-box-content">
                      <span class="info-box-text">Taxa Conclus√£o</span>
                      <span class="info-box-number">
                        {% if (atletas_ativos + atletas_concluidos + atletas_eliminados) > 0 %}
                          {{ "%.1f"|format((atletas_concluidos / (atletas_ativos + atletas_concluidos + atletas_eliminados)) * 100) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Atletas do Loop Atual -->
      {% if atletas_loop_atual %}
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-users"></i> 
                Atletas do Loop {{ loop_atual.numero_loop if loop_atual else 'Atual' }}
              </h3>
              <div class="card-tools">
                <span class="badge badge-info">{{ atletas_loop_atual|length }} atletas</span>
              </div>
            </div>
            <div class="card-body table-responsive p-0">
              <table class="table table-hover text-nowrap">
                <thead>
                  <tr>
                    <th>Pos</th>
                    <th>Atleta</th>
                    <th>Status</th>
                    <th>Tempo</th>
                    <th>In√≠cio</th>
                    <th>Fim</th>
                  </tr>
                </thead>
                <tbody>
                  {% for atleta_loop, atleta in atletas_loop_atual %}
                  <tr class="
                    {% if atleta_loop.status.value == 'ATIVO' %}table-success
                    {% elif atleta_loop.status.value == 'CONCLUIDO' %}table-info
                    {% elif atleta_loop.status.value == 'ELIMINADO' %}table-danger
                    {% elif atleta_loop.status.value == 'DNF' %}table-warning
                    {% elif atleta_loop.status.value == 'DNS' %}table-secondary
                    {% endif %}
                  ">
                    <td>{{ loop.index }}</td>
                    <td>
                      <strong>{{ atleta.nome }}</strong>
                      <br><small class="text-muted">{{ atleta.cidade }}</small>
                    </td>
                    <td>
                      {% if atleta_loop.status.value == 'ATIVO' %}
                        <span class="badge badge-success">üèÉ‚Äç‚ôÇÔ∏è ATIVO</span>
                      {% elif atleta_loop.status.value == 'CONCLUIDO' %}
                        <span class="badge badge-primary">‚úÖ CONCLU√çDO</span>
                      {% elif atleta_loop.status.value == 'ELIMINADO' %}
                        <span class="badge badge-danger">‚ùå ELIMINADO</span>
                      {% elif atleta_loop.status.value == 'DNF' %}
                        <span class="badge badge-warning">‚ö†Ô∏è DNF</span>
                      {% elif atleta_loop.status.value == 'DNS' %}
                        <span class="badge badge-secondary">‚è∏Ô∏è DNS</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if atleta_loop.status.value == 'CONCLUIDO' and atleta_loop.tempo_total_segundos %}
                        <strong>{{ atleta_loop.get_tempo_formatado() }}</strong>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if atleta_loop.data_inicio %}
                        {{ atleta_loop.data_inicio.strftime('%H:%M:%S') }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if atleta_loop.data_fim %}
                        {{ atleta_loop.data_fim.strftime('%H:%M:%S') }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Navega√ß√£o entre Loops -->
      {% if loops %}
      <div class="row">
        <div class="col-12">
          <div class="card card-secondary collapsed-card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-history"></i> 
                Hist√≥rico de Loops ({{ total_loops }} loops)
              </h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body" style="display: none;">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="loopSelect">Ir para Loop:</label>
                  <select id="loopSelect" class="form-control" onchange="goToLoop(this.value)">
                    <option value="">Selecione um loop...</option>
                    {% for current_loop in loops %}
                      <option value="{{ current_loop.numero_loop }}" 
                              {% if loop_atual and current_loop.id == loop_atual.id %}selected{% endif %}>
                        Loop #{{ current_loop.numero_loop }} 
                        ({{ current_loop.status.value }})
                        {% if current_loop.data_inicio %}
                          - {{ current_loop.data_inicio.strftime('%d/%m %H:%M') }}
                        {% endif %}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Loop</th>
                      <th>Status</th>
                      <th>In√≠cio</th>
                      <th>Fim</th>
                      <th>Atletas Ativos</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for current_loop in loops_recentes %}
                    <tr>
                      <td><strong>#{{ current_loop.numero_loop }}</strong></td>
                      <td>
                        {% if current_loop.status.value == 'ATIVO' %}
                          <span class="badge badge-success">ATIVO</span>
                        {% elif current_loop.status.value == 'PREPARACAO' %}
                          <span class="badge badge-warning">PREPARA√á√ÉO</span>
                        {% elif current_loop.status.value == 'FINALIZADO' %}
                          <span class="badge badge-secondary">FINALIZADO</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if current_loop.data_inicio %}
                          {{ current_loop.data_inicio.strftime('%d/%m %H:%M') }}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if current_loop.data_fim %}
                          {{ current_loop.data_fim.strftime('%d/%m %H:%M') }}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>{{ current_loop.get_atletas_ativos()|length }}</td>
                      <td>
                        <a href="{{ url_for('loops.view_specific_loop', backyard_id=backyard.id, loop_number=current_loop.numero_loop) }}" 
                           class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-eye"></i> Ver
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </section>
</div>

<script>
function goToLoop(loopNumber) {
  if (loopNumber) {
    window.location.href = "{{ url_for('loops.view_specific_loop', backyard_id=backyard.id, loop_number=0) }}".replace('0', loopNumber);
  }
}
</script>
{% endblock %}
