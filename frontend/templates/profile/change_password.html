{% extends "base.html" %}

{% block title %}Alterar Senha - Back to the Loop{% endblock %}

{% block content %}


    <!-- Page Title -->
    <div class="page-title dark-background" data-aos="fade" style="background-image: url({{ url_for('static', filename='img/hero-bg.png') }});">
      <div class="container position-relative">
      </div>
    </div><!-- End Page Title -->

<!-- Profile Edit Section -->
<section id="services" class="services section">

  <div class="container" data-aos="fade-up" data-aos-delay="100">

          <!-- Section Title -->
          <div class="container section-title" data-aos="fade-up">
            <h2>ALTERAR SENHA</h2>
            <p>{{ current_user.nome }}</p>
          </div><!-- End Section Title -->
    
    <div class="row justify-content-center">
      <div class="col-lg-6">
        
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-key"></i> Alterar Senha
            </h4>
          </div>
          
          <div class="card-body">
            
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            
            <form method="POST" id="changePasswordForm">
              
              <div class="mb-3">
                <label for="current_password" class="form-label">Senha Atual *</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="current_password" name="current_password" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                    <i class="bi bi-eye" id="current_password_icon"></i>
                  </button>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="new_password" class="form-label">Nova Senha *</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="new_password" name="new_password" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                    <i class="bi bi-eye" id="new_password_icon"></i>
                  </button>
                </div>
                <div class="form-text">
                  A senha deve ter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e símbolos.
                </div>
              </div>
              
              <div class="mb-3">
                <label for="confirm_password" class="form-label">Confirmar Nova Senha *</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                    <i class="bi bi-eye" id="confirm_password_icon"></i>
                  </button>
                </div>
              </div>
              
              <!-- Password Strength Indicator -->
              <div class="mb-3">
                <div class="password-strength">
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%"></div>
                  </div>
                  <small class="form-text" id="password-strength-text">Digite uma nova senha para ver a força</small>
                </div>
              </div>
              
              <!-- Password Match Indicator -->
              <div class="mb-3">
                <div id="password-match" class="form-text"></div>
              </div>
              
              <!-- Botões -->
              <div class="d-flex justify-content-between">
                <a href="{{ url_for('profile.edit') }}" class="btn btn-secondary">
                  <i class="bi bi-arrow-left"></i> Voltar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                  <i class="bi bi-check-lg"></i> Alterar Senha
                </button>
              </div>
              
            </form>
          </div>
        </div>
        
      </div>
    </div>
    
  </div>
</section><!-- /Change Password Section -->

{% endblock %}

{% block extra_js %}
<script>
// Toggle password visibility
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '_icon');
  
  if (field.type === 'password') {
    field.type = 'text';
    icon.classList.remove('bi-eye');
    icon.classList.add('bi-eye-slash');
  } else {
    field.type = 'password';
    icon.classList.remove('bi-eye-slash');
    icon.classList.add('bi-eye');
  }
}

// Password strength checker
function checkPasswordStrength(password) {
  let score = 0;
  let feedback = [];
  
  // Length check
  if (password.length >= 8) score += 1;
  else feedback.push('Pelo menos 8 caracteres');
  
  // Lowercase check
  if (/[a-z]/.test(password)) score += 1;
  else feedback.push('Letras minúsculas');
  
  // Uppercase check
  if (/[A-Z]/.test(password)) score += 1;
  else feedback.push('Letras maiúsculas');
  
  // Number check
  if (/[0-9]/.test(password)) score += 1;
  else feedback.push('Números');
  
  // Special character check
  if (/[^A-Za-z0-9]/.test(password)) score += 1;
  else feedback.push('Símbolos');
  
  return { score, feedback };
}

// Update password strength indicator
function updatePasswordStrength() {
  const password = document.getElementById('new_password').value;
  const strengthBar = document.getElementById('password-strength-bar');
  const strengthText = document.getElementById('password-strength-text');
  
  if (!password) {
    strengthBar.style.width = '0%';
    strengthBar.className = 'progress-bar';
    strengthText.textContent = 'Digite uma nova senha para ver a força';
    return;
  }
  
  const { score, feedback } = checkPasswordStrength(password);
  const percentage = (score / 5) * 100;
  
  strengthBar.style.width = percentage + '%';
  
  if (score <= 2) {
    strengthBar.className = 'progress-bar bg-danger';
    strengthText.textContent = 'Fraca - Faltam: ' + feedback.join(', ');
  } else if (score <= 3) {
    strengthBar.className = 'progress-bar bg-warning';
    strengthText.textContent = 'Média - Faltam: ' + feedback.join(', ');
  } else if (score <= 4) {
    strengthBar.className = 'progress-bar bg-info';
    strengthText.textContent = 'Boa - Falta: ' + feedback.join(', ');
  } else {
    strengthBar.className = 'progress-bar bg-success';
    strengthText.textContent = 'Excelente!';
  }
}

// Check password match
function checkPasswordMatch() {
  const newPassword = document.getElementById('new_password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  const matchDiv = document.getElementById('password-match');
  const submitBtn = document.getElementById('submitBtn');
  
  if (!newPassword || !confirmPassword) {
    matchDiv.textContent = '';
    submitBtn.disabled = true;
    return;
  }
  
  if (newPassword === confirmPassword) {
    matchDiv.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> As senhas coincidem</span>';
    
    // Check if password is strong enough
    const { score } = checkPasswordStrength(newPassword);
    submitBtn.disabled = score < 3; // Require at least medium strength
  } else {
    matchDiv.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> As senhas não coincidem</span>';
    submitBtn.disabled = true;
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  const newPasswordField = document.getElementById('new_password');
  const confirmPasswordField = document.getElementById('confirm_password');
  
  newPasswordField.addEventListener('input', function() {
    updatePasswordStrength();
    checkPasswordMatch();
  });
  
  confirmPasswordField.addEventListener('input', checkPasswordMatch);
});
</script>
{% endblock %}
